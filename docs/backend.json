{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Seventeen game, tracked via anonymous authentication.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user. (Primary Key)"
        },
        "personalBestAccuracy": {
          "type": "number",
          "description": "The user's best (lowest) absolute difference from 17.00 seconds across all attempts.",
          "format": "float"
        },
        "totalAttempts": {
          "type": "number",
          "description": "The total number of attempts the user has made.",
          "format": "integer"
        },
        "lastPlayedTime": {
          "type": "string",
          "description": "The timestamp of the user's last game attempt.",
          "format": "date-time"
        }
      },
      "required": [
        "id"
      ]
    },
    "Attempt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Attempt",
      "type": "object",
      "description": "Represents a single attempt by a user to stop the timer at 17 seconds.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the attempt. (Primary Key)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who made this attempt. (Relationship: User 1:N Attempt)"
        },
        "stoppedTime": {
          "type": "number",
          "description": "The time at which the user stopped the timer.",
          "format": "float"
        },
        "deltaFromTarget": {
          "type": "number",
          "description": "The absolute difference between the stopped time and 17.00 seconds.",
          "format": "float"
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp of when the attempt was made.",
          "format": "date-time"
        },
        "deviceType": {
          "type": "string",
          "description": "The type of device used to make the attempt (e.g., 'mobile', 'desktop')."
        }
      },
      "required": [
        "id",
        "userId",
        "stoppedTime",
        "deltaFromTarget",
        "timestamp",
        "deviceType"
      ]
    },
    "GlobalStatistics": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GlobalStatistics",
      "type": "object",
      "description": "Represents aggregated statistics for all game attempts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the global statistics document. Should be a singleton. (Primary Key)"
        },
        "totalPlays": {
          "type": "number",
          "description": "The total number of game attempts made by all users.",
          "format": "integer"
        },
        "averageAccuracy": {
          "type": "number",
          "description": "The average accuracy (absolute difference from 17.00 seconds) across all attempts.",
          "format": "float"
        },
        "failPercentageRange": {
          "type": "number",
          "description": "The percentage of users who failed within a defined range around 17 seconds (e.g., 16.5 - 17.5).",
          "format": "float"
        }
      },
      "required": [
        "id"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles, including their personal best accuracy, total attempts, and last played time.  The 'userId' parameter represents the Firebase Authentication UID. This path enforces path-based ownership, simplifying security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user, matching the Firebase Authentication UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/attempts/{attemptId}",
        "definition": {
          "entityName": "Attempt",
          "schema": {
            "$ref": "#/backend/entities/Attempt"
          },
          "description": "Stores individual game attempts made by a user. Located as a subcollection under the user's document to establish ownership and simplify querying for attempts made by a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user who made the attempt."
            },
            {
              "name": "attemptId",
              "description": "The unique identifier for the attempt."
            }
          ]
        }
      },
      {
        "path": "/global_statistics/{singleton}",
        "definition": {
          "entityName": "GlobalStatistics",
          "schema": {
            "$ref": "#/backend/entities/GlobalStatistics"
          },
          "description": "Stores aggregated statistics for all game attempts. This is a singleton document, meaning there will only ever be one document in this collection.",
          "params": [
            {
              "name": "singleton",
              "description": "A fixed value, such as 'singleton', to ensure there is only one document in this collection."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the \"Everyone Fails at 17\" game, focusing on user data, attempt tracking, and global statistics. It emphasizes authorization independence and optimized querying for game-related data.\n\n1.  **Users Collection (`/users/{userId}`):** Stores user-specific data, including personal best accuracy, total attempts, and last played time. The `userId` is derived from Firebase Authentication's `uid`. This structure adheres to path-based ownership for private user data, simplifying security rules.\n\n2.  **Attempts Subcollection (`/users/{userId}/attempts/{attemptId}`):** Each user has a subcollection of attempts. This hierarchical structure establishes a clear ownership model (User 1:N Attempt). Each attempt document stores details like stopped time, delta from the target time (17 seconds), timestamp, and device type. Authorization independence is guaranteed because access control is implicitly tied to the `userId` in the path. List operations are automatically scoped to the user.\n\n3.  **Global Statistics Document (`/global_statistics/singleton`):** A singleton document stores aggregated game statistics. Access to this document is configured via rules to ensure it is only writable by an administrative function (if write access is needed). This isolates global data from user-specific data.\n\n**Authorization Independence:** The structure achieves authorization independence by avoiding `get()` calls in security rules. User attempts are stored in a subcollection of the user's document, associating the attempt directly with the user's `uid`. Security rules can therefore directly verify that `request.auth.uid == userId` for creating or modifying attempts.\n\n**QAPs (Rules are not Filters):**\n\n*   The segregation of user data and global statistics into separate collections supports secure list operations. Listing attempts is always scoped to a specific user, preventing exposure of other users' data.\n*   The singleton nature of the global statistics document means that listing is not a concern, as there's only one document, and access can be restricted via rules."
  }
}